<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Manipulation Â· FMI.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="FMI.jl logo"/></a><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><a class="tocitem" href="../../features/">Features</a></li><li><a class="tocitem" href="../../faq/">FAQ</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../overview/">Overview</a></li><li><a class="tocitem" href="../simulate/">Simulate</a></li><li><a class="tocitem" href="../parameterize/">Parameterize</a></li><li><a class="tocitem" href="../multiple_instances/">Multiple instances</a></li><li><a class="tocitem" href="../modelica_conference_2021/">Modelica conference 2021</a></li><li class="is-active"><a class="tocitem" href>Manipulation</a><ul class="internal"><li><a class="tocitem" href="#License"><span>License</span></a></li><li><a class="tocitem" href="#Motivation"><span>Motivation</span></a></li><li><a class="tocitem" href="#Introduction-to-the-example"><span>Introduction to the example</span></a></li><li><a class="tocitem" href="#Target-group"><span>Target group</span></a></li><li><a class="tocitem" href="#Other-formats"><span>Other formats</span></a></li><li><a class="tocitem" href="#Getting-started"><span>Getting started</span></a></li><li><a class="tocitem" href="#Code-section"><span>Code section</span></a></li></ul></li><li><a class="tocitem" href="../multithreading/">Multithreading</a></li><li><a class="tocitem" href="../multiprocessing/">Multiprocessing</a></li></ul></li><li><a class="tocitem" href="../../library/">Library Functions</a></li><li><a class="tocitem" href="../../related/">Related Publication</a></li><li><a class="tocitem" href="../../contents/">Contents</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Manipulation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Manipulation</a></li></ul></nav><div class="docs-right"><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Manipulate-a-function"><a class="docs-heading-anchor" href="#Manipulate-a-function">Manipulate a function</a><a id="Manipulate-a-function-1"></a><a class="docs-heading-anchor-permalink" href="#Manipulate-a-function" title="Permalink"></a></h1><p>Tutorial by Johannes Stoljar, Tobias Thummerer</p><h2 id="License"><a class="docs-heading-anchor" href="#License">License</a><a id="License-1"></a><a class="docs-heading-anchor-permalink" href="#License" title="Permalink"></a></h2><pre><code class="language-julia hljs"># Copyright (c) 2021 Tobias Thummerer, Lars Mikelsons, Josef Kircher, Johannes Stoljar
# Licensed under the MIT license. 
# See LICENSE (https://github.com/thummeto/FMI.jl/blob/main/LICENSE) file in the project root for details.</code></pre><h2 id="Motivation"><a class="docs-heading-anchor" href="#Motivation">Motivation</a><a id="Motivation-1"></a><a class="docs-heading-anchor-permalink" href="#Motivation" title="Permalink"></a></h2><p>This Julia Package <em>FMI.jl</em> is motivated by the use of simulation models in Julia. Here the FMI specification is implemented. FMI (<em>Functional Mock-up Interface</em>) is a free standard (<a href="http://fmi-standard.org/">fmi-standard.org</a>) that defines a container and an interface to exchange dynamic models using a combination of XML files, binaries and C code zipped into a single file. The user can thus use simulation models in the form of an FMU (<em>Functional Mock-up Units</em>). Besides loading the FMU, the user can also set values for parameters and states and simulate the FMU both as co-simulation and model exchange simulation.</p><h2 id="Introduction-to-the-example"><a class="docs-heading-anchor" href="#Introduction-to-the-example">Introduction to the example</a><a id="Introduction-to-the-example-1"></a><a class="docs-heading-anchor-permalink" href="#Introduction-to-the-example" title="Permalink"></a></h2><p>This example shows how to overwrite a library function with an own function. For this the FMU model is simulated first without changes. Then the function <code>fmi2GetReal()</code> is overwritten and simulated again. Both simulations are displayed in a graph to show the change caused by overwriting the function. The model used is a one-dimensional spring pendulum with friction. The object-orientated structure of the <em>SpringFrictionPendulum1D</em> can be seen in the following graphic.</p><p><img src="https://github.com/thummeto/FMI.jl/blob/main/docs/src/examples/pics/SpringFrictionPendulum1D.svg?raw=true" alt="svg"/>  </p><h2 id="Target-group"><a class="docs-heading-anchor" href="#Target-group">Target group</a><a id="Target-group-1"></a><a class="docs-heading-anchor-permalink" href="#Target-group" title="Permalink"></a></h2><p>The example is primarily intended for users who work in the field of simulations. The example wants to show how simple it is to use FMUs in Julia.</p><h2 id="Other-formats"><a class="docs-heading-anchor" href="#Other-formats">Other formats</a><a id="Other-formats-1"></a><a class="docs-heading-anchor-permalink" href="#Other-formats" title="Permalink"></a></h2><p>Besides, this <a href="https://github.com/thummeto/FMI.jl/blob/examples/examples/src/manipulation.ipynb">Jupyter Notebook</a> there is also a <a href="https://github.com/thummeto/FMI.jl/blob/examples/examples/src/manipulation.jl">Julia file</a> with the same name, which contains only the code cells and for the documentation there is a <a href="https://github.com/thummeto/FMI.jl/blob/examples/examples/src/manipulation.md">Markdown file</a> corresponding to the notebook.  </p><h2 id="Getting-started"><a class="docs-heading-anchor" href="#Getting-started">Getting started</a><a id="Getting-started-1"></a><a class="docs-heading-anchor-permalink" href="#Getting-started" title="Permalink"></a></h2><h3 id="Installation-prerequisites"><a class="docs-heading-anchor" href="#Installation-prerequisites">Installation prerequisites</a><a id="Installation-prerequisites-1"></a><a class="docs-heading-anchor-permalink" href="#Installation-prerequisites" title="Permalink"></a></h3><table><tr><th style="text-align: left"></th><th style="text-align: left">Description</th><th style="text-align: left">Command</th><th style="text-align: left">Alternative</th></tr><tr><td style="text-align: left">1.</td><td style="text-align: left">Enter Package Manager via</td><td style="text-align: left">]</td><td style="text-align: left"></td></tr><tr><td style="text-align: left">2.</td><td style="text-align: left">Install FMI via</td><td style="text-align: left">add FMI</td><td style="text-align: left">add &quot; https://github.com/ThummeTo/FMI.jl &quot;</td></tr><tr><td style="text-align: left">3.</td><td style="text-align: left">Install FMIZoo via</td><td style="text-align: left">add FMIZoo</td><td style="text-align: left">add &quot; https://github.com/ThummeTo/FMIZoo.jl &quot;</td></tr><tr><td style="text-align: left">4.</td><td style="text-align: left">Install FMICore via</td><td style="text-align: left">add FMICore</td><td style="text-align: left">add &quot; https://github.com/ThummeTo/FMICore.jl &quot;</td></tr><tr><td style="text-align: left">5.</td><td style="text-align: left">Install Plots via</td><td style="text-align: left">add Plots</td><td style="text-align: left"></td></tr></table><h2 id="Code-section"><a class="docs-heading-anchor" href="#Code-section">Code section</a><a id="Code-section-1"></a><a class="docs-heading-anchor-permalink" href="#Code-section" title="Permalink"></a></h2><p>To run the example, the previously installed packages must be included. </p><pre><code class="language-julia hljs"># imports
using FMI
using FMI: fmiSetFctGetReal
using FMIZoo
using FMICore
using Plots</code></pre><h3 id="Simulation-setup"><a class="docs-heading-anchor" href="#Simulation-setup">Simulation setup</a><a id="Simulation-setup-1"></a><a class="docs-heading-anchor-permalink" href="#Simulation-setup" title="Permalink"></a></h3><p>Next, the start time and end time of the simulation are set.</p><pre><code class="language-julia hljs">tStart = 0.0
tStop = 8.0</code></pre><pre><code class="nohighlight hljs">8.0</code></pre><h3 id="Import-FMU"><a class="docs-heading-anchor" href="#Import-FMU">Import FMU</a><a id="Import-FMU-1"></a><a class="docs-heading-anchor-permalink" href="#Import-FMU" title="Permalink"></a></h3><p>In the next lines of code the FMU model from <em>FMIZoo.jl</em> is loaded and the information about the FMU is shown.</p><pre><code class="language-julia hljs"># we use an FMU from the FMIZoo.jl
pathToFMU = get_model_filename(&quot;SpringFrictionPendulum1D&quot;, &quot;Dymola&quot;, &quot;2022x&quot;)

myFMU = fmiLoad(pathToFMU)

fmiInfo(myFMU)</code></pre><pre><code class="nohighlight hljs">#################### Begin information for FMU ####################
	Model name:			SpringFrictionPendulum1D
	FMI-Version:			2.0
	GUID:				{2e178ad3-5e9b-48ec-a7b2-baa5669efc0c}
	Generation tool:		Dymola Version 2022x (64-bit), 2021-10-08
	Generation time:		2022-05-19T06:54:12Z
	Var. naming conv.:		structured
	Event indicators:		24
	Inputs:				0
	Outputs:			0
	States:				2
		33554432 [&quot;mass.s&quot;]
		33554433 [&quot;mass.v&quot;, &quot;mass.v_relfric&quot;]
	Supports Co-Simulation:		true
		Model identifier:	SpringFrictionPendulum1D
		Get/Set State:		true
		Serialize State:	true
		Dir. Derivatives:	true
		Var. com. steps:	true
		Input interpol.:	true
		Max order out. der.:	1
	Supports Model-Exchange:	true
		Model identifier:	SpringFrictionPendulum1D
		Get/Set State:		true
		Serialize State:	true
		Dir. Derivatives:	true
##################### End information for FMU #####################</code></pre><h3 id="Simulate-FMU"><a class="docs-heading-anchor" href="#Simulate-FMU">Simulate FMU</a><a id="Simulate-FMU-1"></a><a class="docs-heading-anchor-permalink" href="#Simulate-FMU" title="Permalink"></a></h3><p>In the next steps the recorded value is defined. The recorded value is the position of the mass. In the function <code>fmiSimulateME()</code> the FMU is simulated in model-exchange mode (ME) with an adaptive step size. In addition, the start and end time and the recorded variables are specified.</p><pre><code class="language-julia hljs">vrs = [&quot;mass.s&quot;]

simData = fmiSimulateME(myFMU, (tStart, tStop); recordValues=vrs)</code></pre><pre><code class="nohighlight hljs">[33m[1mâ [22m[39m[33m[1mWarning: [22m[39mUsing arrays or dicts to store parameters of different types can hurt performance.
[33m[1mâ [22m[39mConsider using tuples instead.
[33m[1mâ [22m[39m[90m@ SciMLBase ~/.julia/packages/SciMLBase/s9wrq/src/performance_warnings.jl:32[39m
[34mSimulating ME-FMU ... 100%|ââââââââââââââââââââââââââââââ| Time: 0:00:23[39m





Model name:
	SpringFrictionPendulum1D
Success:
	true
f(x)-Evaluations:
	In-place: 1377
	Out-of-place: 0
Jacobian-Evaluations:
	âxÌ_âx: 0
	âxÌ_âu: 0
	ây_âx: 0
	ây_âu: 0
Gradient-Evaluations:
	âxÌ_ât: 0
	ây_ât: 0
Callback-Evaluations:
	Condition (event-indicators): 1893
	Time-Choice (event-instances): 0
	Affect (event-handling): 6
	Save values: 131
	Steps completed: 131
States [131]:
	0.0	[0.5, 0.0]
	2.352941176471972e-11	[0.5, 1.0e-10]
	0.002306805098500577	[0.50001131604032, 0.009814511243552598]
	0.01777270244764722	[0.5006746897285066, 0.0761020888387732]
	0.05358198534179392	[0.5061791781920479, 0.231641032514133]
	0.11852691526990361	[0.5303834643745903, 0.5124206161359472]
	0.1848828094709355	[0.573492996354974, 0.7828256191561919]
	0.2648828094709355	[0.6478174725986621, 1.0657732960206507]
	0.3448828094709355	[0.7422425202486511, 1.2823803113750607]
	...
	8.0	[1.0666322778272936, -7.60398591662422e-5]
Values [131]:
	0.0	(0.5,)
	2.352941176471972e-11	(0.5,)
	0.002306805098500577	(0.50001131604032,)
	0.01777270244764722	(0.5006746897285066,)
	0.05358198534179392	(0.5061791781920479,)
	0.11852691526990361	(0.5303834643745903,)
	0.1848828094709355	(0.573492996354974,)
	0.2648828094709355	(0.6478174725986621,)
	0.3448828094709355	(0.7422425202486511,)
	...
	8.0	(1.0666322778272936,)
Events [6]:
	State-Event #11 @ 0.0s
	State-Event #11 @ 0.994s
	State-Event #19 @ 1.9883s
	State-Event #11 @ 2.9831s
	State-Event #19 @ 3.9789s
	State-Event #11 @ 4.977s</code></pre><h3 id="Plotting-FMU"><a class="docs-heading-anchor" href="#Plotting-FMU">Plotting FMU</a><a id="Plotting-FMU-1"></a><a class="docs-heading-anchor-permalink" href="#Plotting-FMU" title="Permalink"></a></h3><p>After the simulation is finished, the result of the FMU for the model-exchange mode can be plotted. In the plot for the FMU it can be seen that the oscillation continues to decrease due to the effect of the friction. If you simulate long enough, the oscillation comes to a standstill in a certain time.</p><pre><code class="language-julia hljs">fig = fmiPlot(simData, states=false)</code></pre><p><img src="../manipulation_files/manipulation_12_0.svg" alt="svg"/></p><h3 id="Override-Function"><a class="docs-heading-anchor" href="#Override-Function">Override Function</a><a id="Override-Function-1"></a><a class="docs-heading-anchor-permalink" href="#Override-Function" title="Permalink"></a></h3><p>After overwriting a function, the previous one is no longer accessible. The original function <code>fmi2GetReal()</code> is cached by storing the address of the pointer. The addresses of the pointers are kept in the FMU and are thus accessible.</p><pre><code class="language-julia hljs"># save, where the original `fmi2GetReal` function was stored, so we can access it in our new function
originalGetReal = myFMU.cGetReal</code></pre><pre><code class="nohighlight hljs">Ptr{Nothing} @0x00007f2cf3769faf</code></pre><p>To overwrite the function <code>fmi2GetReal!()</code>, the function header of the new custom function must be identical to the previous one. The function header looks like <code>fmi2GetReal!(cfunc::Ptr{Nothing}, c::fmi2Component, vr::Union{Array{fmi2ValueReference}, Ptr{fmi2ValueReference}}, nvr::Csize_t, value::Union{Array{fmi2Real}, Ptr{fmi2Real}})::fmi2Status</code>. The information how the FMI2 function are structured can be seen from <a href="https://github.com/ThummeTo/FMICore.jl/blob/main/src/FMI2_c.jl#L718">FMICore.jl</a> or the FMI2.0.3-specification.</p><p>In the new implementation the original function is called by the previously stored pointer. Next there is a special handling if <code>value</code> is a pointer to an array. In this case the pointer is treated as an array, so that the entries are accessible. Otherwise, each value in <code>value</code> is multiplied by two. Finally, the original state of the original function is output.</p><pre><code class="language-julia hljs">function myGetReal!(c::fmi2Component, vr::Union{Array{fmi2ValueReference}, Ptr{fmi2ValueReference}}, 
                    nvr::Csize_t, value::Union{Array{fmi2Real}, Ptr{fmi2Real}})
    # first, we do what the original function does
    status = fmi2GetReal!(originalGetReal, c, vr, nvr, value)

    # if we have a pointer to an array, we must interprete it as array to access elements
    if isa(value, Ptr{fmi2Real})
        value = unsafe_wrap(Array{fmi2Real}, value, nvr, own=false)
    end

    # now, we multiply every value by two (just for fun!)
    for i in 1:nvr 
        value[i] *= 2.0 
    end 

    # return the original status
    return status
end</code></pre><pre><code class="nohighlight hljs">myGetReal! (generic function with 1 method)</code></pre><p>In the next command the original function is overwritten with the new defined function, for which the command <code>fmiSetFctGetReal()</code> is called.</p><pre><code class="language-julia hljs"># no we overwrite the original function
fmiSetFctGetReal(myFMU, myGetReal!)</code></pre><pre><code class="nohighlight hljs">Ptr{Nothing} @0x00007f2dd2183fc0</code></pre><h3 id="Simulate-and-Plot-FMU-with-modified-function"><a class="docs-heading-anchor" href="#Simulate-and-Plot-FMU-with-modified-function">Simulate and Plot FMU with modified function</a><a id="Simulate-and-Plot-FMU-with-modified-function-1"></a><a class="docs-heading-anchor-permalink" href="#Simulate-and-Plot-FMU-with-modified-function" title="Permalink"></a></h3><p>As before, the identical command is called here for simulation. This is also a model exchange simulation. Immediately afterwards, the results are added to the previous graph as a dashed line.</p><pre><code class="language-julia hljs">simData = fmiSimulateME(myFMU, (tStart, tStop); recordValues=vrs)
fmiPlot!(fig, simData; states=false, style=:dash)</code></pre><pre><code class="nohighlight hljs">[33m[1mâ [22m[39m[33m[1mWarning: [22m[39mUsing arrays or dicts to store parameters of different types can hurt performance.
[33m[1mâ [22m[39mConsider using tuples instead.
[33m[1mâ [22m[39m[90m@ SciMLBase ~/.julia/packages/SciMLBase/s9wrq/src/performance_warnings.jl:32[39m</code></pre><p><img src="../manipulation_files/manipulation_20_1.svg" alt="svg"/></p><p>As expected by overwriting the function, all values are doubled.</p><h3 id="Unload-FMU"><a class="docs-heading-anchor" href="#Unload-FMU">Unload FMU</a><a id="Unload-FMU-1"></a><a class="docs-heading-anchor-permalink" href="#Unload-FMU" title="Permalink"></a></h3><p>After plotting the data, the FMU is unloaded and all unpacked data on disc is removed.</p><pre><code class="language-julia hljs">fmiUnload(myFMU)</code></pre><h3 id="Summary"><a class="docs-heading-anchor" href="#Summary">Summary</a><a id="Summary-1"></a><a class="docs-heading-anchor-permalink" href="#Summary" title="Permalink"></a></h3><p>In this tutorial it is shown how an existing function of the library can be replaced by an own implementation. Through this possibility, there are almost no limits for the user, whereby the user can customize the function to his liking.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../modelica_conference_2021/">Â« Modelica conference 2021</a><a class="docs-footer-nextpage" href="../multithreading/">Multithreading Â»</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Friday 21 July 2023 20:05">Friday 21 July 2023</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
